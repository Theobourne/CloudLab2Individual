@{
    Layout = "_Layout";
}
@model List<UniversityWeb.Controllers.HealthCheckResult>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Health Monitoring</h1>
  <div>
    <span class="small text-muted me-3">Polling interval: 5 secs</span>
    <a class="btn btn-primary btn-sm" href="/Health" onclick="event.preventDefault(); location.reload();">Stop Polling</a>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <table class="health-table">
      <thead>
        <tr>
          <th style="width: 50px;"></th>
          <th>NAME</th>
          <th>HEALTH</th>
          <th>DURATION</th>
          <th>LAST EXECUTION</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var check in Model)
        {
          var isHealthy = check.Status.Equals("Healthy", StringComparison.OrdinalIgnoreCase);
          <tr class="health-row" data-service="@check.Name">
            <td class="text-center">
              <button class="btn-expand" onclick="toggleDetails('@check.Name')">+</button>
            </td>
            <td class="fw-semibold">@check.Name HTTP Check</td>
            <td>
              @if (isHealthy)
              {
                <span class="status-badge status-healthy">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <circle cx="8" cy="8" r="7" fill="#d1e7dd"/>
                    <path d="M6.5 9.5l-2-2 1-1 1 1 3.5-3.5 1 1z" fill="#0f5132"/>
                  </svg>
                  Healthy
                </span>
              }
              else
              {
                <span class="status-badge status-unhealthy">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <circle cx="8" cy="8" r="7" fill="#f8d7da"/>
                    <path d="M5 5l6 6M11 5l-6 6" stroke="#842029" stroke-width="2"/>
                  </svg>
                  Unhealthy
                </span>
              }
            </td>
            <td>@check.Duration</td>
            <td>@check.LastExecution.ToString("M/d/yyyy, h:mm:ss tt")</td>
          </tr>
          <tr class="health-details" id="details-@check.Name" style="display: none;">
            <td colspan="5">
              <div class="details-content">
                @if (check.Checks.Any())
                {
                  <table class="sub-health-table">
                    <thead>
                      <tr>
                        <th>Check Name</th>
                        <th>Status</th>
                        <th>Description</th>
                        <th>Duration</th>
                      </tr>
                    </thead>
                    <tbody>
                      @foreach (var entry in check.Checks)
                      {
                        var entryHealthy = entry.Status.Equals("Healthy", StringComparison.OrdinalIgnoreCase);
                        <tr>
                          <td>@entry.Name</td>
                          <td>
                            @if (entryHealthy)
                            {
                              <span class="status-icon-sm status-healthy">?</span>
                            }
                            else
                            {
                              <span class="status-icon-sm status-unhealthy">?</span>
                            }
                            <span>@entry.Status</span>
                          </td>
                          <td>@(entry.Description ?? "-")</td>
                          <td>@entry.Duration</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                }
                else if (!string.IsNullOrEmpty(check.Error))
                {
                  <div class="alert alert-danger small">
                    <strong>Error:</strong> @check.Error
                  </div>
                }
                else
                {
                  <div class="text-muted small">No detailed health checks available</div>
                }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<style>
  .health-table { width: 100%; border-collapse: collapse; }
  .health-table thead { background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
  .health-table th { padding: .75rem; text-align: left; font-weight: 600; font-size: .875rem; color: #6c757d; text-transform: uppercase; }
  .health-table td { padding: .75rem; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
  .health-row { cursor: pointer; transition: background .2s; }
  .health-row:hover { background: #f8f9fa; }
  .btn-expand { border: none; background: transparent; cursor: pointer; font-weight: bold; font-size: 1.2rem; padding: 0; width: 30px; height: 30px; color: #6c757d; transition: all .2s; }
  .btn-expand:hover { color: #0d6efd; transform: scale(1.1); }
  
  .status-badge { display: inline-flex; align-items: center; gap: .5rem; padding: .25rem .75rem; border-radius: 1rem; font-size: .875rem; font-weight: 600; }
  .status-healthy { background: #d1e7dd; color: #0f5132; }
  .status-unhealthy { background: #f8d7da; color: #842029; }
  
  .status-icon-sm { font-weight: bold; font-size: 1.1em; margin-right: .25rem; }
  .status-icon-sm.status-healthy { color: #0f5132; }
  .status-icon-sm.status-unhealthy { color: #842029; }
  
  .health-details { background: #f8f9fa; }
  .details-content { padding: 1.5rem 2rem; }
  .sub-health-table { width: 100%; margin-top: .5rem; background: #fff; border-radius: .375rem; overflow: hidden; }
  .sub-health-table th { padding: .75rem; text-align: left; font-weight: 600; font-size: .875rem; background: #fff; border-bottom: 2px solid #dee2e6; }
  .sub-health-table td { padding: .75rem; font-size: .875rem; background: #fff; border-bottom: 1px solid #f0f0f0; }
  .sub-health-table tbody tr:last-child td { border-bottom: none; }
</style>

<script>
  function toggleDetails(serviceName) {
    var details = document.getElementById('details-' + serviceName);
    var button = document.querySelector('[data-service="' + serviceName + '"] .btn-expand');
    if (details.style.display === 'none') {
      details.style.display = 'table-row';
      button.textContent = '?';
    } else {
      details.style.display = 'none';
      button.textContent = '+';
    }
  }

  // Auto-refresh every 5 seconds
  setTimeout(function() {
    location.reload();
  }, 5000);
</script>
